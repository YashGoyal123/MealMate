{% extends 'base.html' %}
{% load static %}

{% block title %}{{ recipe.title }} - MealMate{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Recipe Header -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <h1 class="display-4 mb-3">{{ recipe.title }}</h1>
            <p class="lead text-muted">{{ recipe.description }}</p>
            
            <div class="d-flex align-items-center mb-3">
                <img src="https://ui-avatars.com/api/?name={{ recipe.author.username }}&background=007bff&color=fff" 
                     alt="{{ recipe.author.username }}" class="rounded-circle me-2" width="40" height="40">
                <div>
                    <small class="text-muted">By <strong>{{ recipe.author.username }}</strong></small><br>
                    <small class="text-muted">{{ recipe.created_at|date:"F d, Y" }}</small>
                </div>
            </div>
            
            <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-primary">{{ recipe.category.name }}</span>
                {% for tag in recipe.dietary_tags.all %}
                <span class="badge bg-success">{{ tag.name }}</span>
                {% endfor %}
                <span class="badge bg-info">{{ recipe.get_difficulty_display }}</span>
            </div>
        </div>
        
        <div class="col-lg-4 text-lg-end">
            {% if user.is_authenticated %}
            <form method="post" action="{% url 'recipes:toggle_favorite' recipe.slug %}" class="d-inline" id="favoriteForm">
                {% csrf_token %}
                {% if is_favorite %}
                <button type="submit" class="btn btn-danger mb-2" id="favoriteBtn" data-is-favorite="true">
                    <i class="fas fa-heart-broken me-2"></i><span id="favoriteText">Remove from Favorites</span>
                </button>
                {% else %}
                <button type="submit" class="btn btn-outline-danger mb-2" id="favoriteBtn" data-is-favorite="false">
                    <i class="far fa-heart me-2"></i><span id="favoriteText">Add to Favorites</span>
                </button>
                {% endif %}
            </form>
            <br>
            <a href="{% url 'shopping:add_recipe_to_list' recipe.slug %}" class="btn btn-success mb-2">
                <i class="fas fa-cart-plus me-2"></i>Add to Shopping List
            </a>
            {% endif %}
            
            {% if user == recipe.author %}
            <div class="btn-group" role="group">
                <a href="{% url 'recipes:recipe_update' recipe.slug %}" class="btn btn-warning">
                    <i class="fas fa-edit"></i> Edit
                </a>
                <a href="{% url 'recipes:recipe_delete' recipe.slug %}" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <!-- Recipe Media (Image & Video) -->
        <div class="col-lg-8">
            {% if recipe.image %}
            <img src="{{ recipe.image.url }}" class="img-fluid rounded shadow mb-4" alt="{{ recipe.title }}">
            {% else %}
            <div class="bg-secondary rounded d-flex align-items-center justify-content-center mb-4" style="height: 400px;">
                <i class="fas fa-utensils fa-5x text-white"></i>
            </div>
            {% endif %}
            
            {% if recipe.video %}
            <div class="mb-4">
                <h5 class="mb-3"><i class="fas fa-video me-2 text-primary"></i>Recipe Video</h5>
                <div class="ratio ratio-16x9 rounded overflow-hidden shadow-lg position-relative">
                    <video 
                        id="recipeVideo"
                        controls 
                        preload="metadata"
                        class="w-100 h-100"
                        style="object-fit: contain; background-color: #000;">
                        <source src="{{ recipe.video.url }}" type="video/mp4">
                        <source src="{{ recipe.video.url }}" type="video/webm">
                        <source src="{{ recipe.video.url }}" type="video/ogg">
                        Your browser does not support the video tag.
                    </video>
                </div>
                
                <!-- Custom Video Controls -->
                <div class="d-flex justify-content-center gap-2 mt-3">
                    <button class="btn btn-sm btn-outline-primary" id="skipBackwardBtn">
                        <i class="fas fa-backward me-1"></i>10s
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="playPauseBtn">
                        <i class="fas fa-play me-1"></i>Play
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="skipForwardBtn">
                        <i class="fas fa-forward me-1"></i>10s
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="muteBtn">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="fullscreenBtn">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                
                <small class="text-muted d-block mt-2 text-center">
                    <i class="fas fa-info-circle me-1"></i>Use the controls above or click the video player controls
                </small>
            </div>
            {% endif %}
        </div>
        
        <!-- Recipe Info Card -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Recipe Info</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="fas fa-clock text-primary me-2"></i>Prep Time:</span>
                        <strong>{{ recipe.prep_time }} min</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="fas fa-fire text-danger me-2"></i>Cook Time:</span>
                        <strong>{{ recipe.cook_time }} min</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="fas fa-hourglass-half text-warning me-2"></i>Total Time:</span>
                        <strong>{{ recipe.total_time }} min</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="fas fa-users text-info me-2"></i>Servings:</span>
                        <strong>{{ recipe.servings }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span><i class="fas fa-heart text-danger me-2"></i>Favorites:</span>
                        <strong>{{ recipe.favorite_count }}</strong>
                    </div>
                </div>
            </div>
            
            <!-- Nutrition Info -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-apple-alt me-2"></i>Nutrition (per serving)</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span>Calories:</span>
                        <strong>{{ recipe.calories }} kcal</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span>Protein:</span>
                        <strong>{{ recipe.protein }}g</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span>Carbs:</span>
                        <strong>{{ recipe.carbs }}g</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span>Fat:</span>
                        <strong>{{ recipe.fat }}g</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Fiber:</span>
                        <strong>{{ recipe.fiber }}g</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredients & Instructions -->
    <div class="row mt-4">
        <!-- Ingredients -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning">
                    <h4 class="mb-0"><i class="fas fa-list me-2"></i>Ingredients</h4>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for ingredient in recipe.ingredients.all %}
                        <li class="list-group-item">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <strong>{{ ingredient.quantity }} {{ ingredient.unit }}</strong> {{ ingredient.name }}
                            {% if ingredient.notes %}
                            <small class="text-muted">({{ ingredient.notes }})</small>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0"><i class="fas fa-tasks me-2"></i>Instructions</h4>
                </div>
                <div class="card-body">
                    <ol class="list-group list-group-numbered">
                        {% for instruction in recipe.instructions.all %}
                        <li class="list-group-item">
                            {{ instruction.description }}
                        </li>
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4 class="mb-0"><i class="fas fa-star me-2"></i>Reviews ({{ recipe.reviews.count }})</h4>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated and user != recipe.author %}
                    <form method="post" action="{% url 'recipes:add_review' recipe.slug %}" class="mb-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Your Rating:</label>
                            <select name="rating" class="form-select" required>
                                <option value="">Choose...</option>
                                <option value="5">5 - Excellent</option>
                                <option value="4">4 - Very Good</option>
                                <option value="3">3 - Good</option>
                                <option value="2">2 - Fair</option>
                                <option value="1">1 - Poor</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Your Review:</label>
                            <textarea name="comment" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-1"></i>Submit Review
                        </button>
                    </form>
                    {% elif user.is_authenticated and user == recipe.author %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>You cannot review your own recipe.
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <a href="{% url 'account_login' %}">Login</a> to leave a review.
                    </div>
                    {% endif %}
                    
                    <hr>
                    
                    {% for review in recipe.reviews.all %}
                    <div class="mb-4 border-bottom pb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>{{ review.user.username }}</strong>
                                <span class="text-warning ms-2">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star"></i>
                                        {% else %}
                                        <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </span>
                            </div>
                            <div class="d-flex align-items-center">
                                <small class="text-muted me-3">{{ review.created_at|date:"M d, Y" }}</small>
                                {% if user.is_authenticated and user == review.user %}
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#editReviewModal{{ review.id }}">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <form method="post" action="{% url 'recipes:delete_review' recipe.slug review.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this review?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        <p class="mb-2">{{ review.comment }}</p>
                        
                        <!-- Recipe Author's Reply -->
                        {% if review.reply %}
                        <div class="ms-4 mt-3 p-3 bg-light rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong class="text-primary">
                                        <i class="fas fa-reply me-1"></i>{{ recipe.author.username }} (Author)
                                    </strong>
                                </div>
                                {% if user.is_authenticated and user == recipe.author %}
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="collapse" data-bs-target="#editReplyForm{{ review.id }}">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <form method="post" action="{% url 'recipes:delete_reply' recipe.slug review.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this reply?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            <p class="mb-0" id="replyText{{ review.id }}">{{ review.reply }}</p>
                            
                            <!-- Edit Reply Form -->
                            {% if user.is_authenticated and user == recipe.author %}
                            <div class="collapse mt-3" id="editReplyForm{{ review.id }}">
                                <form method="post" action="{% url 'recipes:reply_to_review' recipe.slug review.id %}">
                                    {% csrf_token %}
                                    <div class="mb-2">
                                        <textarea name="reply" class="form-control" rows="3" required>{{ review.reply }}</textarea>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-save me-1"></i>Update Reply
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="collapse" data-bs-target="#editReplyForm{{ review.id }}">
                                        Cancel
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        {% elif user.is_authenticated and user == recipe.author %}
                        <!-- Reply Form for Recipe Author -->
                        <div class="ms-4 mt-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#replyForm{{ review.id }}">
                                <i class="fas fa-reply me-1"></i>Reply
                            </button>
                            <div class="collapse mt-2" id="replyForm{{ review.id }}">
                                <form method="post" action="{% url 'recipes:reply_to_review' recipe.slug review.id %}">
                                    {% csrf_token %}
                                    <div class="mb-2">
                                        <textarea name="reply" class="form-control" rows="3" placeholder="Write your reply..." required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>Send Reply
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Edit Review Modal -->
                    {% if user.is_authenticated and user == review.user %}
                    <div class="modal fade" id="editReviewModal{{ review.id }}" tabindex="-1" aria-labelledby="editReviewModalLabel{{ review.id }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editReviewModalLabel{{ review.id }}">Edit Review</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="post" action="{% url 'recipes:edit_review' recipe.slug review.id %}">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label class="form-label">Rating:</label>
                                            <div class="d-flex gap-2">
                                                {% for i in "12345" %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="rating" id="edit_rating{{ review.id }}_{{ forloop.counter }}" value="{{ forloop.counter }}" {% if review.rating == forloop.counter %}checked{% endif %} required>
                                                    <label class="form-check-label" for="edit_rating{{ review.id }}_{{ forloop.counter }}">
                                                        {{ forloop.counter }}â˜…
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Your Review:</label>
                                            <textarea name="comment" class="form-control" rows="4">{{ review.comment }}</textarea>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>Update Review
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% empty %}
                    <p class="text-muted text-center">No reviews yet. Be the first to review!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load video controls from external file with cache-busting version -->
<script src="{% static 'js/video-controls.js' %}?v=20251026164200"></script>

<style>
    /* Ensure video controls are always visible and clickable */
    video {
        outline: none;
    }
    
    video::-webkit-media-controls {
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    video::-webkit-media-controls-panel {
        display: flex !important;
        opacity: 1 !important;
    }
    
    video::-webkit-media-controls-play-button,
    video::-webkit-media-controls-timeline,
    video::-webkit-media-controls-current-time-display,
    video::-webkit-media-controls-time-remaining-display,
    video::-webkit-media-controls-mute-button,
    video::-webkit-media-controls-volume-slider,
    video::-webkit-media-controls-fullscreen-button {
        display: block !important;
    }
    
    /* Firefox */
    video::-moz-media-controls {
        visibility: visible !important;
    }
    
    /* Ensure controls are always on top */
    video::cue {
        z-index: 9999;
    }
</style>

<script>
    // Favorite button toggle with instant feedback
    document.addEventListener('DOMContentLoaded', function() {
        const favoriteForm = document.getElementById('favoriteForm');
        if (favoriteForm) {
            favoriteForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const btn = document.getElementById('favoriteBtn');
                const icon = btn.querySelector('i');
                const text = document.getElementById('favoriteText');
                const isFavorite = btn.getAttribute('data-is-favorite') === 'true';
                
                // Optimistically update UI
                if (isFavorite) {
                    // Change to "Add to Favorites"
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                    icon.classList.remove('fas', 'fa-heart-broken');
                    icon.classList.add('far', 'fa-heart');
                    text.textContent = 'Add to Favorites';
                    btn.setAttribute('data-is-favorite', 'false');
                } else {
                    // Change to "Remove from Favorites"
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                    icon.classList.remove('far', 'fa-heart');
                    icon.classList.add('fas', 'fa-heart-broken');
                    text.textContent = 'Remove from Favorites';
                    btn.setAttribute('data-is-favorite', 'true');
                }
                
                // Submit the form
                fetch(favoriteForm.action, {
                    method: 'POST',
                    body: new FormData(favoriteForm),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => {
                    if (!response.ok) {
                        // Revert on error
                        location.reload();
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    location.reload();
                });
            });
        }
    });
</script>

<style>
    /* Dark mode fixes for recipe detail page */
    .card-header.bg-danger,
    .card-header.bg-success {
        color: white !important;
    }
    
    .card-header.bg-danger {
        background: var(--danger) !important;
    }
    
    .card-header.bg-success {
        background: var(--success) !important;
    }
    
    .border-bottom {
        border-color: var(--border-color) !important;
    }
    
    [data-theme="dark"] .card-header.bg-danger,
    [data-theme="dark"] .card-header.bg-success {
        opacity: 0.95;
    }
    
    /* Fix text visibility in dark mode */
    [data-theme="dark"] .card-body span,
    [data-theme="dark"] .card-body strong {
        color: var(--text) !important;
    }
    
    [data-theme="dark"] .card-body {
        color: var(--text) !important;
    }
</style>
{% endblock %}
