{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Recipe - MealMate{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %} me-2"></i>
                        {% if form.instance.pk %}Edit Recipe{% else %}Create New Recipe{% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="recipeForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}
                        
                        <!-- Basic Information -->
                        <h5 class="border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">Recipe Title *</label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                <div class="text-danger small">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.category.id_for_label }}" class="form-label">Category *</label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                <div class="text-danger small">{{ form.category.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description *</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.dietary_tags.id_for_label }}" class="form-label">Dietary Tags</label>
                                {{ form.dietary_tags }}
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                                {% if form.dietary_tags.errors %}
                                <div class="text-danger small">{{ form.dietary_tags.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.image.id_for_label }}" class="form-label">
                                    <i class="fas fa-image me-2"></i>Recipe Image
                                </label>
                                {{ form.image }}
                                {% if recipe.image %}
                                <small class="text-muted d-block mt-1">Current: {{ recipe.image.name }}</small>
                                {% endif %}
                                {% if form.image.errors %}
                                <div class="text-danger small">{{ form.image.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.video.id_for_label }}" class="form-label">
                                    <i class="fas fa-video me-2"></i>Recipe Video (Optional)
                                </label>
                                {{ form.video }}
                                {% if recipe.video %}
                                <small class="text-muted d-block mt-1">Current: {{ recipe.video.name }}</small>
                                {% endif %}
                                {% if form.video.errors %}
                                <div class="text-danger small">{{ form.video.errors }}</div>
                                {% endif %}
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>Supported formats: MP4, WebM, OGG (Max 100MB)
                                </small>
                            </div>
                        </div>
                        
                        <!-- Time & Servings -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-clock me-2"></i>Time & Servings</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.prep_time.id_for_label }}" class="form-label">Prep Time (min) *</label>
                                {{ form.prep_time }}
                                {% if form.prep_time.errors %}
                                <div class="text-danger small">{{ form.prep_time.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.cook_time.id_for_label }}" class="form-label">Cook Time (min) *</label>
                                {{ form.cook_time }}
                                {% if form.cook_time.errors %}
                                <div class="text-danger small">{{ form.cook_time.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.servings.id_for_label }}" class="form-label">Servings *</label>
                                {{ form.servings }}
                                {% if form.servings.errors %}
                                <div class="text-danger small">{{ form.servings.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="{{ form.difficulty.id_for_label }}" class="form-label">Difficulty *</label>
                                {{ form.difficulty }}
                                {% if form.difficulty.errors %}
                                <div class="text-danger small">{{ form.difficulty.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Nutrition Information -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-apple-alt me-2"></i>Nutrition (per serving)</h5>
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.calories.id_for_label }}" class="form-label">Calories</label>
                                {{ form.calories }}
                                {% if form.calories.errors %}
                                <div class="text-danger small">{{ form.calories.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.protein.id_for_label }}" class="form-label">Protein (g)</label>
                                {{ form.protein }}
                                {% if form.protein.errors %}
                                <div class="text-danger small">{{ form.protein.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.carbohydrates.id_for_label }}" class="form-label">Carbs (g)</label>
                                {{ form.carbohydrates }}
                                {% if form.carbohydrates.errors %}
                                <div class="text-danger small">{{ form.carbohydrates.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.fat.id_for_label }}" class="form-label">Fat (g)</label>
                                {{ form.fat }}
                                {% if form.fat.errors %}
                                <div class="text-danger small">{{ form.fat.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.fiber.id_for_label }}" class="form-label">Fiber (g)</label>
                                {{ form.fiber }}
                                {% if form.fiber.errors %}
                                <div class="text-danger small">{{ form.fiber.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label d-block">&nbsp;</label>
                                <div class="form-check">
                                    {{ form.is_public }}
                                    <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                                        Public Recipe
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ingredients -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-list me-2"></i>Ingredients</h5>
                        {{ ingredient_formset.management_form }}
                        <div id="ingredient-forms">
                            {% for form in ingredient_formset %}
                            <div class="ingredient-form row mb-2">
                                {{ form.id }}
                                <div class="col-md-3">
                                    <label class="form-label small">Amount</label>
                                    {{ form.amount }}
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label small">Ingredient Name</label>
                                    {{ form.name }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Order</label>
                                    {{ form.order }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small d-block">&nbsp;</label>
                                    {{ form.DELETE }}
                                    <button type="button" class="btn btn-danger btn-sm delete-ingredient">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-success btn-sm mb-3" id="add-ingredient">
                            <i class="fas fa-plus me-1"></i>Add Ingredient
                        </button>
                        
                        <!-- Instructions -->
                        <h5 class="border-bottom pb-2 mb-3 mt-4"><i class="fas fa-tasks me-2"></i>Instructions</h5>
                        {{ instruction_formset.management_form }}
                        <div id="instruction-forms">
                            {% for form in instruction_formset %}
                            <div class="instruction-form row mb-2">
                                {{ form.id }}
                                <div class="col-md-1">
                                    <label class="form-label small">Step #</label>
                                    {{ form.step_number }}
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label small">Description</label>
                                    {{ form.description }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Image</label>
                                    {{ form.image }}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small d-block">&nbsp;</label>
                                    {{ form.DELETE }}
                                    <button type="button" class="btn btn-danger btn-sm delete-instruction">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-success btn-sm mb-3" id="add-instruction">
                            <i class="fas fa-plus me-1"></i>Add Instruction
                        </button>
                        
                        <!-- Submit Buttons -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Save Recipe
                            </button>
                            <a href="{% url 'recipes:recipe_list' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    input[type="checkbox"][id*="DELETE"] {
        display: none !important;
    }
</style>

<script>
    // Delete Ingredient functionality
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-ingredient')) {
            const ingredientForm = e.target.closest('.ingredient-form');
            const deleteCheckbox = ingredientForm.querySelector('input[name$="-DELETE"]');
            
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                ingredientForm.style.display = 'none';
            } else {
                ingredientForm.remove();
                const totalForms = document.querySelector('input[name="ingredients-TOTAL_FORMS"]');
                totalForms.value = parseInt(totalForms.value) - 1;
            }
        }
        
        if (e.target.closest('.delete-instruction')) {
            const instructionForm = e.target.closest('.instruction-form');
            const deleteCheckbox = instructionForm.querySelector('input[name$="-DELETE"]');
            
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                instructionForm.style.display = 'none';
            } else {
                instructionForm.remove();
                const totalForms = document.querySelector('input[name="instructions-TOTAL_FORMS"]');
                totalForms.value = parseInt(totalForms.value) - 1;
            }
        }
    });
    
    // Add Ingredient functionality
    document.getElementById('add-ingredient').addEventListener('click', function() {
        const formContainer = document.getElementById('ingredient-forms');
        const totalForms = document.querySelector('input[name="ingredients-TOTAL_FORMS"]');
        const formNum = parseInt(totalForms.value);
        
        // Count visible forms to get correct order number
        const visibleForms = Array.from(formContainer.querySelectorAll('.ingredient-form'))
            .filter(form => form.style.display !== 'none');
        const nextOrderNumber = visibleForms.length + 1;
        
        const emptyForm = document.querySelector('.ingredient-form').cloneNode(true);
        emptyForm.style.display = '';
        
        const formRegex = new RegExp('ingredients-(\\d+)-', 'g');
        emptyForm.innerHTML = emptyForm.innerHTML.replace(formRegex, `ingredients-${formNum}-`);
        
        emptyForm.querySelectorAll('input, textarea, select').forEach(input => {
            if (input.type !== 'checkbox') {
                input.value = '';
            } else {
                input.checked = false;
            }
        });
        
        const orderInput = emptyForm.querySelector('input[name$="-order"]');
        if (orderInput) {
            orderInput.value = nextOrderNumber;
        }
        
        formContainer.appendChild(emptyForm);
        totalForms.value = formNum + 1;
    });
    
    // Add Instruction functionality
    document.getElementById('add-instruction').addEventListener('click', function() {
        const formContainer = document.getElementById('instruction-forms');
        const totalForms = document.querySelector('input[name="instructions-TOTAL_FORMS"]');
        const formNum = parseInt(totalForms.value);
        
        // Count visible forms to get correct step number
        const visibleForms = Array.from(formContainer.querySelectorAll('.instruction-form'))
            .filter(form => form.style.display !== 'none');
        const nextStepNumber = visibleForms.length + 1;
        
        const emptyForm = document.querySelector('.instruction-form').cloneNode(true);
        emptyForm.style.display = '';
        
        const formRegex = new RegExp('instructions-(\\d+)-', 'g');
        emptyForm.innerHTML = emptyForm.innerHTML.replace(formRegex, `instructions-${formNum}-`);
        
        emptyForm.querySelectorAll('input, textarea, select').forEach(input => {
            if (input.type !== 'checkbox' && input.type !== 'file') {
                input.value = '';
            } else {
                input.checked = false;
            }
        });
        
        const stepNumberInput = emptyForm.querySelector('input[name$="-step_number"]');
        if (stepNumberInput) {
            stepNumberInput.value = nextStepNumber;
        }
        
        formContainer.appendChild(emptyForm);
        totalForms.value = formNum + 1;
    });
</script>

{% endblock %}
